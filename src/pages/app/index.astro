---
import Layout from '../../layouts/Layout.astro';
import BottomNav from '../../components/BottomNav.astro';
import { SURAH_INFO, MULK_VERSES } from '../../data/mulk-verses';
---

<Layout title="Paneli">
  <div class="min-h-screen flex flex-col bg-[var(--color-background)]">
    
    <!-- Header with gradient -->
    <header class="bg-gradient-to-br from-[#005086] to-[var(--color-header)] text-white px-4 py-3 safe-top shadow-lg">
      <div class="max-w-lg mx-auto flex items-center justify-between">
        <div>
          <h1 class="text-lg font-semibold tracking-tight">Mulk 30</h1>
          <p class="text-xs text-white/70">Sfida e Ramazanit</p>
        </div>
        <button id="theme-toggle" class="w-11 h-11 rounded-full bg-white/10 flex items-center justify-center active:scale-95 transition-transform" aria-label="Ndrysho temÃ«n">
          <svg id="icon-moon" class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
          <svg id="icon-sun" class="w-5 h-5 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 py-6 pb-44">
      <div class="max-w-lg mx-auto space-y-6">

        <!-- HERO: Progress Circle + Current Day -->
        <div class="card text-center py-8">
          <!-- Circular Progress Ring -->
          <div class="relative inline-flex items-center justify-center mb-4">
            <svg class="w-32 h-32 -rotate-90" viewBox="0 0 120 120">
              <!-- Background circle -->
              <circle cx="60" cy="60" r="52" fill="none" stroke="var(--color-border)" stroke-width="8"/>
              <!-- Progress circle -->
              <circle 
                id="progress-ring" 
                cx="60" 
                cy="60" 
                r="52" 
                fill="none" 
                stroke="var(--color-primary)" 
                stroke-width="8"
                stroke-linecap="round"
                stroke-dasharray="326.73"
                stroke-dashoffset="326.73"
                class="transition-all duration-700 ease-out"
              />
            </svg>
            <!-- Center content -->
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span id="current-day-num" class="text-4xl font-bold text-[var(--color-primary)]">1</span>
              <span class="text-xs text-[var(--color-text-secondary)] uppercase tracking-wider">Dita</span>
            </div>
          </div>
          
          <!-- Progress Text -->
          <div class="mb-2">
            <p class="text-lg font-semibold text-[var(--color-text)]" id="progress-label">Fillimi i udhÃ«timit</p>
            <p class="text-sm text-[var(--color-text-secondary)]" id="progress-subtitle">MÃ«so ajetin e parÃ« tÃ« Surah Al-Mulk</p>
          </div>
          
          <!-- Streak Badge (if active) -->
          <div id="streak-badge" class="hidden inline-flex items-center gap-1.5 bg-[var(--color-primary)]/10 text-[var(--color-primary)] px-3 py-1.5 rounded-full text-sm font-medium mt-2 shadow-sm">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 23c-3.6 0-7-2.4-7-7 0-3.1 2.7-6.4 5-9.1V2l2.5 2L15 2v4.9c2.3 2.7 5 6 5 9.1 0 4.6-3.4 7-8 7z"/>
            </svg>
            <span id="streak-text">0 ditÃ« radhazi</span>
          </div>
        </div>

        <!-- PRIMARY CTA: Continue Learning Button - THUMB ZONE -->
        <a id="continue-btn" href="/app/day/1" class="block w-full bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary-dark)] hover:from-[var(--color-primary-light)] hover:to-[var(--color-primary)] text-white text-center font-semibold py-5 px-6 rounded-2xl active:scale-[0.98] transition-all shadow-lg shadow-[#318fb5]/35 hover:shadow-xl hover:shadow-[#318fb5]/45 hover:-translate-y-0.5">
          <div class="flex items-center justify-center gap-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="cta-text">Fillo mÃ«simin</span>
          </div>
        </a>

        <!-- Today's Step Status (Compact) -->
        <div id="today-steps-card" class="card">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-[var(--color-text)]">Progresi i ditÃ«s</span>
            <span class="text-xs text-[var(--color-text-secondary)]" id="today-progress-text">0/3 hapa</span>
          </div>
          <div class="flex items-center gap-3">
            <!-- Listen -->
            <div id="step-listen" class="flex-1 text-center p-3 rounded-xl bg-[var(--color-background)] border border-transparent">
              <div class="w-8 h-8 mx-auto mb-1 rounded-full bg-[var(--color-primary)]/10 flex items-center justify-center">
                <svg class="w-4 h-4 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M6.5 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h2.5l4-4v14l-4-4z"></path>
                </svg>
              </div>
              <span class="text-xs text-[var(--color-text-secondary)]" id="listen-status">0/10</span>
            </div>
            <!-- Read -->
            <div id="step-read" class="flex-1 text-center p-3 rounded-xl bg-[var(--color-background)] border border-transparent">
              <div class="w-8 h-8 mx-auto mb-1 rounded-full bg-[var(--color-accent)]/10 flex items-center justify-center">
                <svg class="w-4 h-4 text-[var(--color-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </div>
              <span class="text-xs text-[var(--color-text-secondary)]" id="read-status">0/10</span>
            </div>
            <!-- Recite -->
            <div id="step-recite" class="flex-1 text-center p-3 rounded-xl bg-[var(--color-background)] border border-transparent">
              <div class="w-8 h-8 mx-auto mb-1 rounded-full bg-[var(--color-text)]/10 flex items-center justify-center">
                <svg class="w-4 h-4 text-[var(--color-text)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
              </div>
              <span class="text-xs text-[var(--color-text-secondary)]" id="recite-status">0/10</span>
            </div>
          </div>
        </div>

        <!-- 30 Day Grid (Collapsible - Progressive Disclosure) -->
        <div class="card">
          <button id="toggle-grid" class="w-full flex items-center justify-between py-1">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-[var(--color-text)]">30 ditÃ«t</span>
              <span class="text-xs text-[var(--color-text-secondary)]" id="grid-progress">0/30</span>
            </div>
            <svg id="grid-chevron" class="w-5 h-5 text-[var(--color-text-secondary)] transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <!-- Grid (collapsed by default) -->
          <div id="days-grid" class="hidden mt-4">
            <div class="grid grid-cols-6 gap-2">
              {Array.from({ length: 30 }, (_, i) => i + 1).map((day) => (
                <a 
                  href={`/app/day/${day}`} 
                  class="day-cell aspect-square rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] flex items-center justify-center text-sm font-medium text-[var(--color-text-secondary)] hover:border-[var(--color-primary)] active:scale-95 transition-all"
                  data-day={day}
                >
                  {day}
                </a>
              ))}
            </div>
            <!-- Legend -->
            <div class="flex items-center justify-center gap-4 mt-3 text-xs text-[var(--color-text-secondary)]">
              <div class="flex items-center gap-1">
                <div class="w-3 h-3 rounded bg-[var(--color-primary)]"></div>
                <span>PÃ«rfunduar</span>
              </div>
              <div class="flex items-center gap-1">
                <div class="w-3 h-3 rounded border-2 border-[var(--color-primary)] bg-transparent"></div>
                <span>Sot</span>
              </div>
              <div class="flex items-center gap-1">
                <div class="w-3 h-3 rounded bg-[var(--color-border)]"></div>
                <span>Mbetur</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Motivation Quote (changes based on progress) -->
        <div id="motivation-card" class="text-center py-4">
          <p class="text-sm text-[var(--color-text-secondary)] italic" id="motivation-text">
            "Kush lexon Surah Al-Mulk Ã§do natÃ«, do tÃ« mbrohet nga dÃ«nimi i varrit."
          </p>
          <p class="text-xs text-[var(--color-text-secondary)] mt-1">â€” Hadith</p>
        </div>

      </div>
    </main>

    <!-- Bottom Nav -->
    <BottomNav active="home" />
  </div>
</Layout>

<style>
  /* Day cell states */
  .day-cell.completed {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }
  
  .day-cell.current {
    border-color: var(--color-primary);
    border-width: 2px;
    color: var(--color-primary);
    font-weight: 700;
  }
  
  .day-cell.locked {
    opacity: 0.4;
    pointer-events: none;
  }

  /* Step completed state */
  .step-done {
    border-color: var(--color-primary) !important;
  }
  
  .step-done svg {
    color: var(--color-primary) !important;
  }

  /* Grid animation */
  #days-grid {
    animation: slideDown 0.2s ease-out;
  }
  
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Progress ring glow effect */
  #progress-ring {
    filter: drop-shadow(0 0 8px var(--color-primary)) drop-shadow(0 0 16px rgba(49, 143, 181, 0.4));
  }

  /* Card hover lift effect */
  .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 18, 68, 0.12), 0 4px 8px rgba(0, 80, 134, 0.08);
  }

  /* Step cards subtle hover */
  #step-listen:hover, #step-read:hover, #step-recite:hover {
    background-color: var(--color-surface) !important;
    box-shadow: 0 2px 8px rgba(0, 80, 134, 0.15);
    transform: scale(1.02);
    transition: all 0.15s ease;
  }
</style>

<script>
  import { getState, getCurrentDay, getStreak, getProgress, isDayCompleted, getDayProgress, REQUIRED_COUNT } from '../../lib/challenge';
  import { getSession } from '../../lib/supabase';

  // Auth guard
  (async () => {
    try {
      const { session } = await getSession();
      if (!session) {
        window.location.href = '/auth/login';
        return;
      }
    } catch (e) {
      // Allow offline usage
    }
  })();

  function updateUI() {
    const state = getState();
    const day = getCurrentDay(state);
    const streak = getStreak(state);
    const progress = getProgress(state);
    const completedCount = state.completedDays.length;
    const dayProgress = getDayProgress(day);
    const dayCompleted = isDayCompleted(day);

    // Update circular progress ring
    const ring = document.getElementById('progress-ring') as SVGCircleElement;
    const circumference = 326.73; // 2 * Ï€ * 52
    const offset = circumference - (progress / 100) * circumference;
    ring.style.strokeDashoffset = String(offset);

    // Update current day number
    document.getElementById('current-day-num')!.textContent = String(day);

    // Update progress label based on completion
    const progressLabel = document.getElementById('progress-label')!;
    const progressSubtitle = document.getElementById('progress-subtitle')!;
    
    if (completedCount === 0) {
      progressLabel.textContent = 'Fillimi i udhÃ«timit';
      progressSubtitle.textContent = 'MÃ«so ajetin e parÃ« tÃ« Surah Al-Mulk';
    } else if (completedCount < 7) {
      progressLabel.textContent = `${completedCount} ajete tÃ« memorizuara`;
      progressSubtitle.textContent = 'Java e parÃ« â€” vazhdo kÃ«shtu!';
    } else if (completedCount < 15) {
      progressLabel.textContent = `${completedCount} ajete tÃ« memorizuara`;
      progressSubtitle.textContent = 'Po ndÃ«rton njÃ« zakon tÃ« mirÃ«!';
    } else if (completedCount < 22) {
      progressLabel.textContent = `${completedCount} ajete tÃ« memorizuara`;
      progressSubtitle.textContent = 'Mbi gjysmÃ«n! Mos u ndal!';
    } else if (completedCount < 30) {
      progressLabel.textContent = `${completedCount} ajete tÃ« memorizuara`;
      progressSubtitle.textContent = 'Fundi po afron! VetÃ«m pak ditÃ«!';
    } else {
      progressLabel.textContent = 'Masha\'Allah!';
      progressSubtitle.textContent = 'E pÃ«rfundove Surah Al-Mulk!';
    }

    // Streak badge
    const streakBadge = document.getElementById('streak-badge')!;
    const streakText = document.getElementById('streak-text')!;
    if (streak > 0) {
      streakBadge.classList.remove('hidden');
      streakText.textContent = `${streak} ditÃ« radhazi ðŸ”¥`;
    } else {
      streakBadge.classList.add('hidden');
    }

    // Update CTA button
    const continueBtn = document.getElementById('continue-btn') as HTMLAnchorElement;
    const ctaText = document.getElementById('cta-text')!;
    continueBtn.href = `/app/day/${day}`;
    
    if (completedCount === 0) {
      ctaText.textContent = 'Fillo mÃ«simin';
    } else if (dayCompleted) {
      if (day < 30) {
        ctaText.textContent = `Vazhdo me DitÃ«n ${day + 1}`;
        continueBtn.href = `/app/day/${day + 1}`;
      } else {
        ctaText.textContent = 'Rishiko sfidat';
      }
    } else {
      ctaText.textContent = `Vazhdo DitÃ«n ${day}`;
    }

    // Update today's steps
    document.getElementById('listen-status')!.textContent = `${Math.min(dayProgress.listenCount, REQUIRED_COUNT)}/${REQUIRED_COUNT}`;
    document.getElementById('read-status')!.textContent = `${Math.min(dayProgress.readCount, REQUIRED_COUNT)}/${REQUIRED_COUNT}`;
    document.getElementById('recite-status')!.textContent = `${Math.min(dayProgress.reciteCount, REQUIRED_COUNT)}/${REQUIRED_COUNT}`;

    // Calculate completed steps
    const stepsCompleted = 
      (dayProgress.listenCount >= REQUIRED_COUNT ? 1 : 0) +
      (dayProgress.readCount >= REQUIRED_COUNT ? 1 : 0) +
      (dayProgress.reciteCount >= REQUIRED_COUNT ? 1 : 0);
    document.getElementById('today-progress-text')!.textContent = `${stepsCompleted}/3 hapa`;

    // Style completed steps
    if (dayProgress.listenCount >= REQUIRED_COUNT) {
      document.getElementById('step-listen')!.classList.add('step-done');
    }
    if (dayProgress.readCount >= REQUIRED_COUNT) {
      document.getElementById('step-read')!.classList.add('step-done');
    }
    if (dayProgress.reciteCount >= REQUIRED_COUNT) {
      document.getElementById('step-recite')!.classList.add('step-done');
    }

    // Update grid progress
    document.getElementById('grid-progress')!.textContent = `${completedCount}/30`;

    // Update day cells
    document.querySelectorAll('.day-cell').forEach((cell) => {
      const cellDay = parseInt(cell.getAttribute('data-day') || '0');
      cell.classList.remove('completed', 'current', 'locked');
      
      if (state.completedDays.includes(cellDay)) {
        cell.classList.add('completed');
      } else if (cellDay === day) {
        cell.classList.add('current');
      } else if (cellDay > day && !state.completedDays.includes(cellDay - 1)) {
        // Future days are accessible but styled differently
      }
    });

    // Hide today's steps card if challenge complete
    if (completedCount === 30) {
      document.getElementById('today-steps-card')!.classList.add('hidden');
    }
  }

  // Toggle grid visibility
  document.getElementById('toggle-grid')?.addEventListener('click', () => {
    const grid = document.getElementById('days-grid')!;
    const chevron = document.getElementById('grid-chevron')!;
    
    if (grid.classList.contains('hidden')) {
      grid.classList.remove('hidden');
      chevron.style.transform = 'rotate(180deg)';
    } else {
      grid.classList.add('hidden');
      chevron.style.transform = 'rotate(0deg)';
    }
  });

  // Theme toggle
  const toggle = document.getElementById('theme-toggle');
  function updateThemeIcons() {
    const dark = document.documentElement.classList.contains('dark');
    document.getElementById('icon-moon')?.classList.toggle('hidden', dark);
    document.getElementById('icon-sun')?.classList.toggle('hidden', !dark);
  }
  toggle?.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    updateThemeIcons();
  });

  // Initialize
  updateUI();
  updateThemeIcons();
</script>
