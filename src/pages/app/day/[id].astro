---
import Layout from '../../../layouts/Layout.astro';
import BottomNav from '../../../components/BottomNav.astro';
import { MULK_VERSES, SURAH_INFO, getVerseByDay } from '../../../data/mulk-verses';

export function getStaticPaths() {
  return MULK_VERSES.map((v) => ({ params: { id: String(v.dayIndex) } }));
}

const { id } = Astro.params;
const dayIndex = parseInt(id);
const verse = getVerseByDay(dayIndex)!;
const prevDay = dayIndex > 1 ? dayIndex - 1 : null;
const nextDay = dayIndex < 30 ? dayIndex + 1 : null;
---

<Layout title={`Dita ${dayIndex}`}>
  <div id="page-root" class="min-h-screen flex flex-col bg-[var(--color-background)]">
    <!-- Focus Mode Close Button -->
    <button id="focus-close" class="hidden fixed z-50 w-10 h-10 rounded-full bg-[var(--color-text)]/10 flex items-center justify-center text-[var(--color-text-secondary)] hover:bg-[var(--color-text)]/20 transition-all" style="top: calc(env(safe-area-inset-top, 0px) + 12px); right: 16px;">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>

    <!-- Header -->
    <header class="sticky top-0 z-10 bg-[var(--color-surface)]/80 backdrop-blur-lg border-b border-[var(--color-border)] px-4 py-3 safe-top">
      <div class="max-w-lg mx-auto flex items-center justify-between">
        <a href="/app" class="w-10 h-10 rounded-full bg-[var(--color-background)] flex items-center justify-center active:scale-95 transition-transform shadow-sm" aria-label="Kthehu">
          <svg class="w-5 h-5 text-[var(--color-text)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <div class="text-center">
          <h1 class="text-lg font-semibold text-[var(--color-text)] tracking-tight">Dita {dayIndex}</h1>
          <p class="text-xs text-[var(--color-text-secondary)]">Ajeti {verse.ayahNumber} • {SURAH_INFO.name}</p>
        </div>
        <button id="focus-btn" class="w-10 h-10 rounded-full bg-[var(--color-background)] flex items-center justify-center active:scale-95 transition-transform shadow-sm" title="Focus Mode" aria-label="Focus Mode">
          <svg class="w-5 h-5 text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
        </button>
      </div>
    </header>

    <main class="flex-1 px-4 py-6">
      <div class="max-w-lg mx-auto space-y-4">

        <!-- Arabic Text Card with Zoom -->
        <div id="arabic-card" class="bg-[var(--color-surface)] rounded-3xl p-10 border border-[var(--color-border)] shadow-lg overflow-hidden relative" style="box-shadow: inset 0 0 30px rgba(0,0,0,0.03), 0 10px 15px -3px rgba(0,0,0,0.1)">
          <div id="arabic-zoom-wrapper" class="arabic-zoomable">
            <p class="arabic arabic-xl text-center text-[var(--color-text)]" id="arabic-text">{verse.arabic}</p>
          </div>
          <!-- Zoom controls -->
          <div class="flex items-center justify-center gap-2 mt-3 pt-2 border-t border-[var(--color-border)] opacity-60">
            <button id="zoom-out" class="w-6 h-6 rounded-full bg-[var(--color-background)] border border-[var(--color-border)] flex items-center justify-center text-[var(--color-text-secondary)] active:scale-90 transition-transform" aria-label="Zvogëlo tekstin">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
            </button>
            <span id="zoom-level" class="text-[10px] text-[var(--color-text-secondary)] tabular-nums w-8 text-center">100%</span>
            <button id="zoom-in" class="w-6 h-6 rounded-full bg-[var(--color-background)] border border-[var(--color-border)] flex items-center justify-center text-[var(--color-text-secondary)] active:scale-90 transition-transform" aria-label="Zmadho tekstin">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
          </div>
        </div>

        <!-- Hidden text card (for memorize mode) -->
        <div id="arabic-hidden" class="hidden bg-[var(--color-surface)] rounded-3xl p-10 border border-violet-500/20 shadow-lg text-center">
          <div id="memorize-hidden" class="space-y-3">
            <svg class="w-12 h-12 mx-auto text-violet-400/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
            <p class="text-[var(--color-text-secondary)] text-sm">Thuaje nga memoria!</p>
          </div>
          <div id="memorize-peek" class="hidden">
            <p class="arabic text-[var(--color-text)] leading-[2.2] opacity-40" style="font-size:1.5rem">{verse.arabic}</p>
          </div>
        </div>

        <!-- Transliteration (#18: text-[13px] → text-sm for readability) -->
        <p id="transliteration" class="text-center text-sm text-[var(--color-text-secondary)] italic leading-relaxed">{verse.transliteration}</p>

        <!-- Audio Progress Bar (only visible during listen) -->
        <div id="audio-bar-container" class="hidden px-2">
          <div class="w-full h-1.5 bg-[var(--color-border)] rounded-full overflow-hidden">
            <div id="audio-progress" class="h-full bg-sky-600 rounded-full transition-all duration-100" style="width:0%"></div>
          </div>
        </div>

        <!-- Done Panel (above buttons) -->
        <div id="panel-done" class="hidden text-center space-y-6 py-4">
          <div id="confetti-container" class="relative">
            <div class="w-20 h-20 mx-auto rounded-full bg-[var(--color-primary)] flex items-center justify-center animate-bounce-in">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
          </div>
          <div>
            <h2 class="text-xl font-bold text-[var(--color-text)]">Masha'Allah!</h2>
            <p class="text-sm text-[var(--color-text-secondary)] mt-1">E ke përfunduar Ditën {dayIndex}!</p>
          </div>
        </div>

        <!-- 3 Action Buttons Row -->
        <div class="flex items-center justify-center gap-8">
          <!-- Listen -->
          <div class="flex flex-col items-center gap-1.5">
            <button id="listen-btn" class="action-btn w-14 h-14 rounded-full flex items-center justify-center transition-all active:scale-90 bg-sky-600/8 border border-sky-600/20 text-sky-700 hover:bg-sky-600/15" title="Dëgjo">
              <svg id="listen-icon" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M17.95 6.05a8 8 0 010 11.9M6.5 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h2.5l4-4v14l-4-4z"></path></svg>
              <svg id="pause-icon" class="w-7 h-7 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <span class="text-xs font-medium tabular-nums" id="listen-counter">
              <span id="listen-count" class="text-sky-700 font-bold">0</span><span class="text-[var(--color-text-secondary)] tracking-wide">/10</span>
            </span>
          </div>

          <!-- Read -->
          <div id="read-wrapper" class="flex flex-col items-center gap-1.5">
            <button id="read-btn" class="action-btn w-14 h-14 rounded-full flex items-center justify-center transition-all active:scale-90 bg-teal-600/8 border border-teal-600/20 text-teal-700 hover:bg-teal-600/15" title="Lexo">
              <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
            </button>
            <span class="text-xs font-medium tabular-nums" id="read-counter">
              <span id="read-count" class="text-teal-700 font-bold">0</span><span class="text-[var(--color-text-secondary)] tracking-wide">/10</span>
            </span>
          </div>

          <!-- Recite / Memorize -->
          <div id="recite-wrapper" class="flex flex-col items-center gap-1.5">
            <button id="recite-btn" class="action-btn w-14 h-14 rounded-full flex items-center justify-center transition-all active:scale-90 bg-violet-500/8 border border-violet-500/20 text-violet-600 hover:bg-violet-500/15" title="Mëso përmendësh">
              <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            </button>
            <span class="text-xs font-medium tabular-nums" id="recite-counter">
              <span id="recite-count" class="text-violet-600 font-bold">0</span><span class="text-[var(--color-text-secondary)] tracking-wide">/10</span>
            </span>
          </div>
        </div>

        <!-- Translation Toggle -->
        <div class="pt-2">
          <button id="translation-toggle" class="w-full flex items-center justify-between px-5 py-4 rounded-2xl bg-[var(--color-surface)] border border-[var(--color-border)] shadow-sm text-sm text-[var(--color-text-secondary)] hover:bg-[var(--color-background)] transition-colors active:scale-[0.99]">
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg>
              Shiko përkthimin
            </span>
            <svg id="translation-chevron" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div id="translation-content" class="hidden mt-3 px-5 py-4 bg-[var(--color-surface)] rounded-2xl border border-[var(--color-border)] shadow-sm animate-slide-down">
            <p class="text-[var(--color-text)] leading-relaxed">{verse.albanian}</p>
          </div>
        </div>

        <!-- Navigation -->
        <div id="day-nav" class="flex gap-4 pt-2">
          {prevDay ? (
            <a href={`/app/day/${prevDay}`} class="btn btn-secondary flex-1 py-3.5">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
              Dita {prevDay}
            </a>
          ) : <div class="flex-1"></div>}
          {nextDay ? (
            <a href={`/app/day/${nextDay}`} class="btn btn-secondary flex-1 justify-end py-3.5">
              Dita {nextDay}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </a>
          ) : <div class="flex-1"></div>}
        </div>
      </div>
    </main>

    <!-- Bottom Nav (shared component #6) -->
    <BottomNav />
  </div>
</Layout>

<style>
  @keyframes bounce-in {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
  }
  .animate-bounce-in { animation: bounce-in 0.5s ease-out; }

  @keyframes slide-down {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-slide-down { animation: slide-down 0.2s ease-out; }

  @keyframes confetti-fall {
    0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100px) rotate(720deg); opacity: 0; }
  }
  .confetti-piece {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 2px;
    animation: confetti-fall 1.5s ease-out forwards;
  }

  .action-btn.completed {
    opacity: 1;
  }
  .action-btn.completed::after {
    content: '✓';
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 18px;
    height: 18px;
    background: #10b981;
    color: white;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .action-btn { position: relative; }

  /* Locked state */
  #page-root {
    transition: all 0.3s ease;
  }
  #focus-close {
    opacity: 0;
    transition: opacity 0.3s ease 0.2s;
  }
  #focus-close.visible {
    opacity: 1;
  }

  .action-btn.locked {
    opacity: 0.35 !important;
    pointer-events: none !important;
    border-color: #9CA3AF !important;
    color: #9CA3AF !important;
    background-color: transparent !important;
    background: transparent !important;
  }

  /* Counter bounce */
  @keyframes count-bump {
    0% { transform: scale(1); }
    40% { transform: scale(1.5); }
    100% { transform: scale(1); }
  }
  .count-bump {
    animation: count-bump 0.3s ease-out;
  }

  /* Step complete pulse */
  @keyframes step-pulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5); }
    70% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
  }
  .step-pulse {
    animation: step-pulse 0.6s ease-out;
  }
</style>

<style is:global>
  /* Focus Mode — must be global to target unscoped elements */
  .focus-mode header,
  .focus-mode nav.sticky,
  .focus-mode #translation-toggle,
  .focus-mode #translation-content,
  .focus-mode #transliteration,
  .focus-mode #audio-bar-container,
  .focus-mode #day-nav {
    display: none !important;
  }
  .focus-mode main {
    display: flex;
    flex: 1;
    align-items: center;
    justify-content: center;
    padding: 0 1rem !important;
  }
  .focus-mode main > div {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 85vh;
    width: 100%;
    gap: 2rem;
  }
  .focus-mode #arabic-card {
    border: none !important;
    box-shadow: none !important;
    background: transparent !important;
    transform: scale(1.05);
  }
  .focus-mode #arabic-card .flex {
    display: none !important;
  }
  .focus-mode #arabic-hidden {
    border: none !important;
    box-shadow: none !important;
    background: transparent !important;
  }
  .focus-mode .action-btn {
    width: 4rem !important;
    height: 4rem !important;
  }
  .focus-mode .action-btn svg {
    width: 1.75rem !important;
    height: 1.75rem !important;
  }
</style>

<script define:vars={{ dayIndex }}>
  window.__dayIndex = dayIndex;
</script>

<script>
  import { getDayProgress, incrementStep, getActiveStep, REQUIRED_COUNT } from '../../../lib/challenge';
  import { getSession } from '../../../lib/supabase';

  // Auth guard (#3)
  (async () => {
    try {
      const { session } = await getSession();
      if (!session) {
        window.location.href = '/auth/login';
        return;
      }
    } catch (e) {
      // Allow offline usage
    }
  })();

  const dayIndex = (window as any).__dayIndex;
  let progress = getDayProgress(dayIndex);
  let audioPlaying = false;
  let audioTimer: ReturnType<typeof setInterval> | null = null;
  let audioProgressVal = 0;
  let memorizeMode = false;

  function showConfetti() {
    const container = document.getElementById('confetti-container');
    if (!container) return;
    const colors = ['#10b981', '#8b5cf6', '#3b82f6', '#f59e0b', '#ef4444', '#ec4899'];
    for (let i = 0; i < 30; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      piece.style.left = `${Math.random() * 100}%`;
      piece.style.top = '0';
      piece.style.animationDelay = `${Math.random() * 0.5}s`;
      piece.style.animationDuration = `${1 + Math.random() * 1}s`;
      container.appendChild(piece);
      setTimeout(() => piece.remove(), 2500);
    }
  }

  function bumpCount(el: HTMLElement | null) {
    if (!el) return;
    el.classList.remove('count-bump');
    void el.offsetWidth; // reflow
    el.classList.add('count-bump');
  }

  function updateCounters(changed?: 'listen' | 'read' | 'recite') {
    const lc = document.getElementById('listen-count');
    const rc = document.getElementById('read-count');
    const rcc = document.getElementById('recite-count');
    if (lc) lc.textContent = String(Math.min(progress.listenCount, REQUIRED_COUNT));
    if (rc) rc.textContent = String(Math.min(progress.readCount, REQUIRED_COUNT));
    if (rcc) rcc.textContent = String(Math.min(progress.reciteCount, REQUIRED_COUNT));
    if (changed === 'listen') bumpCount(lc);
    if (changed === 'read') bumpCount(rc);
    if (changed === 'recite') bumpCount(rcc);
  }

  function updateButtons() {
    const listenBtn = document.getElementById('listen-btn')!;
    const readBtn = document.getElementById('read-btn')!;
    const reciteBtn = document.getElementById('recite-btn')!;

    // Sequential locking
    const listenDone = progress.listenCount >= REQUIRED_COUNT;
    const readDone = progress.readCount >= REQUIRED_COUNT;
    const reciteDone = progress.reciteCount >= REQUIRED_COUNT;

    // Read: locked until listen done
    const readWrap = document.getElementById('read-wrapper')!;
    const reciteWrap = document.getElementById('recite-wrapper')!;

    if (!listenDone) {
      readWrap.style.opacity = '0.3';
      readBtn.style.pointerEvents = 'none';
      readBtn.style.cssText = 'opacity:1;pointer-events:none;border-color:#9CA3AF!important;color:#9CA3AF!important;background:transparent!important;';
    } else if (!readDone) {
      readWrap.style.opacity = '';
      readBtn.style.cssText = '';
    }

    // Recite: locked until read done
    if (!readDone) {
      reciteWrap.style.opacity = '0.3';
      reciteBtn.style.pointerEvents = 'none';
      reciteBtn.style.cssText = 'opacity:1;pointer-events:none;border-color:#9CA3AF!important;color:#9CA3AF!important;background:transparent!important;';
    } else if (!reciteDone) {
      reciteWrap.style.opacity = '';
      reciteBtn.style.cssText = '';
    }

    // Mark completed buttons with filled style + pulse
    if (listenDone) {
      if (!listenBtn.classList.contains('completed')) {
        listenBtn.classList.add('step-pulse');
        setTimeout(() => listenBtn.classList.remove('step-pulse'), 600);
      }
      listenBtn.classList.add('completed', 'bg-sky-600', 'text-white', 'border-sky-600');
      listenBtn.classList.remove('bg-sky-600/8', 'text-sky-700', 'border-sky-600/20');
    }
    if (readDone) {
      if (!readBtn.classList.contains('completed')) {
        readBtn.classList.add('step-pulse');
        setTimeout(() => readBtn.classList.remove('step-pulse'), 600);
      }
      readBtn.classList.add('completed', 'bg-teal-600', 'text-white', 'border-teal-600');
      readBtn.classList.remove('bg-teal-600/8', 'text-teal-700', 'border-teal-600/20');
    }
    if (reciteDone) {
      if (!reciteBtn.classList.contains('completed')) {
        reciteBtn.classList.add('step-pulse');
        setTimeout(() => reciteBtn.classList.remove('step-pulse'), 600);
      }
      reciteBtn.classList.add('completed', 'bg-violet-500', 'text-white', 'border-violet-500');
      reciteBtn.classList.remove('bg-violet-500/8', 'text-violet-600', 'border-violet-500/20');
    }
  }

  function checkDone() {
    const done = progress.listenCount >= REQUIRED_COUNT &&
                 progress.readCount >= REQUIRED_COUNT &&
                 progress.reciteCount >= REQUIRED_COUNT;
    const panel = document.getElementById('panel-done')!;
    if (done) {
      panel.classList.remove('hidden');
      showConfetti();
    }
    return done;
  }

  function render(changed?: 'listen' | 'read' | 'recite') {
    updateCounters(changed);
    updateButtons();
    checkDone();
  }

  // (#4) Listen — simulated audio playback with progress bar UX
  // TODO: Replace simulation with real audio files (e.g., Al-Afasy recitation per verse)
  // Use <audio> element or Web Audio API for actual playback
  function startAudio() {
    if (audioPlaying) return stopAudio();

    // Exit memorize mode if active
    if (memorizeMode) exitMemorizeMode();

    audioPlaying = true;
    const listenIcon = document.getElementById('listen-icon')!;
    const pauseIcon = document.getElementById('pause-icon')!;
    listenIcon.classList.add('hidden');
    pauseIcon.classList.remove('hidden');

    const barContainer = document.getElementById('audio-bar-container')!;
    barContainer.classList.remove('hidden');
    audioProgressVal = 0;
    const bar = document.getElementById('audio-progress')!;

    audioTimer = setInterval(() => {
      audioProgressVal += 2;
      bar.style.width = `${audioProgressVal}%`;
      if (audioProgressVal >= 100) {
        stopAudio();
        progress = incrementStep(dayIndex, 'listen');
        render('listen');
      }
    }, 50);
  }

  function stopAudio() {
    audioPlaying = false;
    if (audioTimer) clearInterval(audioTimer);
    audioTimer = null;
    const listenIcon = document.getElementById('listen-icon');
    const pauseIcon = document.getElementById('pause-icon');
    if (listenIcon) listenIcon.classList.remove('hidden');
    if (pauseIcon) pauseIcon.classList.add('hidden');
    const bar = document.getElementById('audio-progress');
    if (bar) bar.style.width = '0%';
    const barContainer = document.getElementById('audio-bar-container');
    if (barContainer) barContainer.classList.add('hidden');
  }

  // Memorize mode — hide text
  function enterMemorizeMode() {
    memorizeMode = true;
    document.getElementById('arabic-card')!.classList.add('hidden');
    document.getElementById('arabic-hidden')!.classList.remove('hidden');
    document.getElementById('transliteration')!.classList.add('hidden');
  }

  function exitMemorizeMode() {
    memorizeMode = false;
    document.getElementById('arabic-card')!.classList.remove('hidden');
    document.getElementById('arabic-hidden')!.classList.add('hidden');
    document.getElementById('transliteration')!.classList.remove('hidden');
    // Reset peek
    document.getElementById('memorize-hidden')!.classList.remove('hidden');
    document.getElementById('memorize-peek')!.classList.add('hidden');
  }

  // Event listeners
  document.getElementById('listen-btn')?.addEventListener('click', startAudio);

  document.getElementById('read-btn')?.addEventListener('click', () => {
    if (memorizeMode) exitMemorizeMode();
    progress = incrementStep(dayIndex, 'read');
    render('read');
  });

  document.getElementById('recite-btn')?.addEventListener('click', () => {
    if (!memorizeMode) enterMemorizeMode();
    progress = incrementStep(dayIndex, 'recite');
    render('recite');
  });

  // Peek in memorize mode
  document.getElementById('arabic-hidden')?.addEventListener('click', () => {
    const hidden = document.getElementById('memorize-hidden')!;
    const peek = document.getElementById('memorize-peek')!;
    if (hidden.classList.contains('hidden')) {
      hidden.classList.remove('hidden');
      peek.classList.add('hidden');
    } else {
      hidden.classList.add('hidden');
      peek.classList.remove('hidden');
    }
  });

  // Translation toggle
  let translationOpen = false;
  document.getElementById('translation-toggle')?.addEventListener('click', () => {
    translationOpen = !translationOpen;
    const content = document.getElementById('translation-content')!;
    const chevron = document.getElementById('translation-chevron')!;
    content.classList.toggle('hidden', !translationOpen);
    chevron.style.transform = translationOpen ? 'rotate(180deg)' : '';
    // Add/remove left border accent
    const toggleBtn = document.getElementById('translation-toggle')!;
    if (translationOpen) {
      toggleBtn.classList.add('border-l-2', '!border-l-[var(--color-primary)]');
    } else {
      toggleBtn.classList.remove('border-l-2', '!border-l-[var(--color-primary)]');
    }
  });

  // Zoom controls
  let zoomLevel = 100;
  const zoomWrapper = document.getElementById('arabic-zoom-wrapper');
  const zoomLabel = document.getElementById('zoom-level');
  const ZOOM_STEP = 15;
  const ZOOM_MIN = 70;
  const ZOOM_MAX = 200;

  // Load saved zoom
  const savedZoom = localStorage.getItem('mulk30_zoom');
  if (savedZoom) {
    zoomLevel = parseInt(savedZoom);
    applyZoom();
  }

  function applyZoom() {
    const text = document.getElementById('arabic-text');
    if (text) {
      const baseSizePx = 2.5 * 16; // 2.5rem base (arabic-xl)
      text.style.fontSize = `${baseSizePx * zoomLevel / 100}px`;
    }
    // Only constrain height when zoomed in
    if (zoomWrapper) {
      if (zoomLevel > 100) {
        zoomWrapper.style.maxHeight = '320px';
        zoomWrapper.style.overflowY = 'auto';
      } else {
        zoomWrapper.style.maxHeight = '';
        zoomWrapper.style.overflowY = '';
      }
    }
    if (zoomLabel) zoomLabel.textContent = `${zoomLevel}%`;
    localStorage.setItem('mulk30_zoom', String(zoomLevel));
  }

  document.getElementById('zoom-in')?.addEventListener('click', () => {
    zoomLevel = Math.min(zoomLevel + ZOOM_STEP, ZOOM_MAX);
    applyZoom();
  });

  document.getElementById('zoom-out')?.addEventListener('click', () => {
    zoomLevel = Math.max(zoomLevel - ZOOM_STEP, ZOOM_MIN);
    applyZoom();
  });

  // Pinch-to-zoom on touch devices
  let initialDistance = 0;
  let initialZoom = 100;
  const card = document.getElementById('arabic-card');
  card?.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      initialDistance = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      initialZoom = zoomLevel;
    }
  }, { passive: true });

  card?.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      const dist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      const scale = dist / initialDistance;
      zoomLevel = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, Math.round(initialZoom * scale)));
      applyZoom();
    }
  }, { passive: true });

  // === Focus Mode ===
  let focusMode = sessionStorage.getItem('mulk30_focus') === '1';
  const pageRoot = document.getElementById('page-root')!;
  const focusCloseBtn = document.getElementById('focus-close')!;

  function enterFocusMode() {
    focusMode = true;
    sessionStorage.setItem('mulk30_focus', '1');
    pageRoot.classList.add('focus-mode');
    focusCloseBtn.classList.remove('hidden');
    requestAnimationFrame(() => focusCloseBtn.classList.add('visible'));
    // Try fullscreen
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen().catch(() => {});
    }
  }

  function exitFocusMode() {
    focusMode = false;
    sessionStorage.removeItem('mulk30_focus');
    pageRoot.classList.remove('focus-mode');
    focusCloseBtn.classList.remove('visible');
    setTimeout(() => focusCloseBtn.classList.add('hidden'), 300);
    if (document.fullscreenElement) {
      document.exitFullscreen().catch(() => {});
    }
  }

  document.getElementById('focus-btn')?.addEventListener('click', enterFocusMode);
  focusCloseBtn.addEventListener('click', exitFocusMode);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && focusMode) exitFocusMode();
  });

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement && focusMode) {
      exitFocusMode();
    }
  });

  // Restore focus mode if navigating between days
  if (focusMode) enterFocusMode();

  render();
</script>
</Layout>
